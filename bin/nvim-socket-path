#!/usr/bin/env python3
"""
Display the socket path that would be used for the current terminal.
Useful for debugging and discovering which neovim instance to connect to.
"""

import subprocess
import sys
import os
import glob


def get_socket_path():
    """Get socket path based on current TTY."""
    try:
        result = subprocess.run(['tty'], capture_output=True, text=True)
        tty = result.stdout.strip()

        if not tty or tty == 'not a tty':
            return None

        safe_name = tty.replace('/dev/', '').replace('/', '-')
        return f"/tmp/radish-nvim-{safe_name}.sock"
    except Exception as e:
        return None


def main():
    # Get expected socket path
    socket_path = get_socket_path()

    if not socket_path:
        print("Not running in a TTY", file=sys.stderr)
        print("\nLooking for any radish-nvim sockets:", file=sys.stderr)
        sockets = glob.glob('/tmp/radish-nvim-*.sock')
        if sockets:
            sockets.sort(key=lambda x: os.path.getmtime(x), reverse=True)
            for sock in sockets:
                mtime = os.path.getmtime(sock)
                print(f"  {sock} (modified: {mtime})", file=sys.stderr)
        else:
            print("  No sockets found", file=sys.stderr)
        sys.exit(1)

    print(f"Expected socket path: {socket_path}")

    # Check if it exists
    if os.path.exists(socket_path):
        print(f"Status: ✓ Socket exists")

        # Try to get socket info
        stat = os.stat(socket_path)
        print(f"Mode: {oct(stat.st_mode)}")
        print(f"Owner: {stat.st_uid}")
    else:
        print(f"Status: ✗ Socket does not exist")
        print(f"\nStart neovim in this terminal to create the socket:")
        print(f"  nvim")

        # Show other sockets
        other_sockets = glob.glob('/tmp/radish-nvim-*.sock')
        if other_sockets:
            print(f"\nOther active sockets:")
            for sock in other_sockets:
                print(f"  {sock}")


if __name__ == '__main__':
    main()
